# é™„å½•

## é™„å½•A: å¤§æ¨¡å‹æ¨ç†ä¸ llama.cpp ç®€ä»‹

æ¬¢è¿æ¥åˆ°å®éªŒçš„AIæ¢ç´¢éƒ¨åˆ†ï¼åœ¨æœ¬éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†åˆæ­¥æ¥è§¦äººå·¥æ™ºèƒ½ï¼ˆAIï¼‰åœ¨ç«¯ä¾§è®¾å¤‡ï¼ˆå¦‚æˆ‘ä»¬çš„DAYU200å¼€å‘æ¿ï¼‰ä¸Šè¿›è¡Œæ¨ç†çš„æ¦‚å¿µå’Œå®è·µã€‚ç”±äºå¤§å®¶å¯èƒ½ä¹‹å‰æ²¡æœ‰ç³»ç»Ÿå­¦ä¹ è¿‡AIï¼Œæˆ‘ä»¬ä¼šä»æœ€åŸºæœ¬çš„æ¦‚å¿µå¼€å§‹ã€‚ï¼ˆç”±äºæˆ‘ä»¬æ˜¯æ“ä½œç³»ç»Ÿè¯¾ç¨‹ï¼Œæ‰€ä»¥ä¸ä¼šå¾ˆè¯¦ç»†(Â°Â°)ï½ï¼‰

## 1.1 äººå·¥æ™ºèƒ½ï¼ˆAIï¼‰åŸç†ç®€ä»‹

ä½ å¯èƒ½ç»å¸¸å¬åˆ°â€œäººå·¥æ™ºèƒ½â€æˆ–â€œAIâ€è¿™ä¸ªè¯ï¼Œå®ƒå¬èµ·æ¥å¯èƒ½å¾ˆå¤æ‚ï¼Œä½†å…¶æ ¸å¿ƒæ€æƒ³å…¶å®å¹¶ä¸éš¾ç†è§£ã€‚

### 1.1.1 ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ

ç®€å•æ¥è¯´ï¼Œäººå·¥æ™ºèƒ½çš„ç›®æ ‡æ˜¯è®©è®¡ç®—æœºèƒ½å¤Ÿåƒäººä¸€æ ·æ€è€ƒã€å­¦ä¹ ã€å†³ç­–å’Œè§£å†³é—®é¢˜ã€‚æˆ‘ä»¬å¸Œæœ›æœºå™¨èƒ½å¤Ÿæ‰§è¡Œé‚£äº›é€šå¸¸éœ€è¦äººç±»æ™ºèƒ½æ‰èƒ½å®Œæˆçš„ä»»åŠ¡ï¼Œæ¯”å¦‚è¯†åˆ«å›¾åƒã€ç†è§£è¯­è¨€ã€ä¸‹æ£‹ã€é©¾é©¶æ±½è½¦ç­‰ã€‚

### 1.1.2 æœºå™¨å­¦ä¹  (Machine Learning, ML) - AIçš„æ ¸å¿ƒé©±åŠ¨åŠ›

ç›®å‰å®ç°AIæœ€ä¸»è¦å’Œæœ€æˆåŠŸçš„æ–¹æ³•ä¹‹ä¸€æ˜¯æœºå™¨å­¦ä¹  (ML)ã€‚ä¸ä¼ ç»Ÿç¼–ç¨‹ä¸­æˆ‘ä»¬æ˜ç¡®å‘Šè¯‰è®¡ç®—æœºæ¯ä¸€æ­¥è¯¥æ€ä¹ˆåšä¸åŒï¼Œæœºå™¨å­¦ä¹ çš„æ ¸å¿ƒæ€æƒ³æ˜¯è®©è®¡ç®—æœºä»æ•°æ®ä¸­â€œå­¦ä¹ â€ã€‚

- æ‰“ä¸ªæ¯”æ–¹ï¼š æƒ³è±¡ä¸€ä¸‹æ•™ä¸€ä¸ªå°å­©è¯†åˆ«çŒ«ã€‚ä½ ä¸ä¼šå»ç²¾ç¡®æè¿°çŒ«çš„æ¯ä¸€æ ¹èƒ¡é¡»æˆ–æ¯›å‘çš„æ•°å­¦æ¨¡å‹ï¼Œè€Œæ˜¯ä¼šç»™å¥¹çœ‹å¾ˆå¤šçŒ«çš„å›¾ç‰‡ï¼ˆè¿™äº›å›¾ç‰‡å°±æ˜¯â€œæ•°æ®â€ï¼‰ã€‚é€šè¿‡è§‚å¯Ÿè¶³å¤Ÿå¤šçš„ä¾‹å­ï¼Œå°å­©çš„å¤§è„‘ä¼šè‡ªå·±æ€»ç»“å‡ºçŒ«çš„å…±åŒç‰¹å¾ï¼ˆæ¯”å¦‚æœ‰å°–è€³æœµã€èƒ¡é¡»ã€ç‰¹å®šçš„è„¸å‹ç­‰â€”â€”è¿™å°±æ˜¯â€œå­¦ä¹ â€æˆ–â€œè®­ç»ƒæ¨¡å‹â€çš„è¿‡ç¨‹ï¼‰ã€‚ä¹‹åï¼Œå½“ä½ ç»™å¥¹çœ‹ä¸€å¼ æ–°çš„ã€å¥¹ä»¥å‰æ²¡è§è¿‡çš„çŒ«çš„å›¾ç‰‡æ—¶ï¼Œå¥¹ä¹Ÿèƒ½è®¤å‡ºæ¥ï¼ˆè¿™å°±æ˜¯â€œé¢„æµ‹â€æˆ–â€œæ¨ç†â€ï¼‰ã€‚
- æœºå™¨å­¦ä¹ å°±æ˜¯è®©è®¡ç®—æœºåšç±»ä¼¼çš„äº‹æƒ…ï¼šæˆ‘ä»¬ç»™è®¡ç®—æœºæä¾›å¤§é‡çš„æ•°æ®ï¼ˆæ¯”å¦‚æˆåƒä¸Šä¸‡å¼ æ ‡è®°ä¸ºâ€œçŒ«â€æˆ–â€œç‹—â€çš„å›¾ç‰‡ï¼‰ï¼Œå¹¶ä½¿ç”¨ç‰¹å®šçš„ç®—æ³•ï¼Œè®©è®¡ç®—æœºè‡ªåŠ¨ä»è¿™äº›æ•°æ®ä¸­æ‰¾å‡ºè§„å¾‹å’Œæ¨¡å¼ï¼Œå½¢æˆä¸€ä¸ªâ€œæ¨¡å‹ (Model)â€ã€‚

### 1.1.3 æ·±åº¦å­¦ä¹  (Deep Learning, DL) - æ›´å¼ºå¤§çš„æœºå™¨å­¦ä¹ 

æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œå®ƒä½¿ç”¨ä¸€ç§å«åšâ€œäººå·¥ç¥ç»ç½‘ç»œ (Artificial Neural Networks)â€çš„å¤æ‚æ•°å­¦ç»“æ„ï¼Œç‰¹åˆ«æ˜¯åŒ…å«è®¸å¤šå±‚ï¼ˆæ‰€ä»¥å«â€œæ·±åº¦â€ï¼‰çš„ç¥ç»ç½‘ç»œã€‚è¿™äº›ç½‘ç»œçš„è®¾è®¡çµæ„Ÿæ¥æºäºäººè„‘ç¥ç»å…ƒçš„è¿æ¥æ–¹å¼ã€‚æ·±åº¦å­¦ä¹ åœ¨å¤„ç†å¤æ‚æ•°æ®ï¼ˆå¦‚å›¾åƒã€è¯­éŸ³ã€è‡ªç„¶è¯­è¨€æ–‡æœ¬ï¼‰æ–¹é¢è¡¨ç°å¾—å°¤å…¶å‡ºè‰²ï¼Œè¿‘å¹´æ¥è®¸å¤šAIçš„çªç ´éƒ½å¾—ç›Šäºæ·±åº¦å­¦ä¹ ã€‚æˆ‘ä»¬æœ¬æ¬¡å®éªŒæ¥è§¦çš„è¯­è¨€æ¨¡å‹å°±æ˜¯ä¸€ç§åŸºäºæ·±åº¦å­¦ä¹ çš„å¤§è¯­è¨€æ¨¡å‹ã€‚

æ€»è€Œè¨€ä¹‹ï¼ŒAIï¼ˆå°¤å…¶æ˜¯é€šè¿‡æœºå™¨å­¦ä¹ å’Œæ·±åº¦å­¦ä¹ ï¼‰ä½¿è®¡ç®—æœºèƒ½å¤Ÿé€šè¿‡åˆ†ææ•°æ®æ¥å­¦ä¹ å’Œåšå‡ºæ™ºèƒ½çš„å“åº”ï¼Œè€Œä¸ä»…ä»…æ˜¯æ‰§è¡Œé¢„å…ˆç¼–ç¨‹å¥½çš„æŒ‡ä»¤ã€‚

## 1.2 ä»€ä¹ˆæ˜¯ AI æ¨ç† (Inference)ï¼Ÿ

åœ¨æœºå™¨å­¦ä¹ ï¼ˆåŒ…æ‹¬æ·±åº¦å­¦ä¹ ï¼‰çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œé€šå¸¸æœ‰ä¸¤ä¸ªä¸»è¦é˜¶æ®µï¼š

1. **è®­ç»ƒ (Training)**ï¼š

- è¿™æ˜¯â€œå­¦ä¹ â€çš„é˜¶æ®µï¼Œå°±åƒå‰é¢ä¾‹å­é‡Œå°å­©çœ‹å›¾è¯†çŒ«ï¼Œæˆ–è€…å­¦ç”Ÿå¤‡è€ƒå­¦ä¹ çŸ¥è¯†çš„è¿‡ç¨‹ã€‚
- åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬ä¼šç”¨æµ·é‡çš„æ ‡æ³¨æ•°æ®ï¼ˆä¾‹å¦‚ï¼Œæ•°ç™¾ä¸‡å¼ å›¾ç‰‡åŠå…¶å¯¹åº”çš„æ ‡ç­¾ï¼Œæˆ–è€…TBçº§çš„æ–‡æœ¬æ•°æ®ï¼‰æ¥â€œå–‚â€ç»™ä¸€ä¸ªåˆå§‹çš„ã€æœªå­¦ä¹ çš„AIæ¨¡å‹ã€‚
- é€šè¿‡ç‰¹å®šçš„å­¦ä¹ ç®—æ³•ï¼Œæ¨¡å‹ä¼šè°ƒæ•´å…¶å†…éƒ¨å‚æ•°ï¼Œä»¥ä½¿å…¶èƒ½å¤Ÿå¯¹è¾“å…¥æ•°æ®åšå‡ºæ­£ç¡®çš„å“åº”ï¼ˆä¾‹å¦‚ï¼Œæ­£ç¡®åˆ†ç±»å›¾ç‰‡ï¼Œæˆ–ç†è§£æ–‡æœ¬çš„å«ä¹‰ï¼‰ã€‚
- è®­ç»ƒè¿‡ç¨‹é€šå¸¸éœ€è¦éå¸¸å¼ºå¤§çš„è®¡ç®—èµ„æºï¼ˆå¦‚é«˜æ€§èƒ½GPUé›†ç¾¤ï¼‰å’Œå¾ˆé•¿çš„æ—¶é—´ï¼ˆå‡ å¤©ã€å‡ å‘¨ç”šè‡³å‡ ä¸ªæœˆï¼‰ã€‚
- è®­ç»ƒçš„æœ€ç»ˆäº§å‡ºæ˜¯ä¸€ä¸ªâ€œè®­ç»ƒå¥½çš„æ¨¡å‹ (Trained Model)â€ â€”â€”å¯ä»¥æŠŠå®ƒçœ‹ä½œæ˜¯åŒ…å«äº†ä»æ•°æ®ä¸­å­¦åˆ°çš„æ‰€æœ‰çŸ¥è¯†å’Œè§„å¾‹çš„â€œå¤§è„‘â€æ–‡ä»¶ã€‚

2. **æ¨ç† (Inference)**ï¼š

- è¿™æ˜¯â€œä½¿ç”¨â€æˆ–â€œåº”ç”¨â€çš„é˜¶æ®µï¼Œå°±åƒå°å­©è¯†åˆ«ä¸€å¼ æ–°çš„çŒ«å›¾ç‰‡ï¼Œæˆ–è€…å­¦ç”Ÿè¿ç”¨æ‰€å­¦çŸ¥è¯†è§£ç­”è€ƒè¯•é¢˜ç›®ã€‚
- åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬æŠŠæ–°çš„ã€æœªæ›¾è§è¿‡çš„æ•°æ®ï¼ˆä¾‹å¦‚ï¼Œç”¨æˆ·ä¸Šä¼ çš„ä¸€å¼ ç…§ç‰‡ï¼Œæˆ–è€…ç”¨æˆ·è¾“å…¥çš„ä¸€æ®µæ–‡å­—ï¼‰è¾“å…¥åˆ°å·²ç»è®­ç»ƒå¥½çš„æ¨¡å‹ä¸­ã€‚
- æ¨¡å‹ä¼šåˆ©ç”¨å®ƒåœ¨è®­ç»ƒé˜¶æ®µå­¦åˆ°çš„çŸ¥è¯†å’Œè§„å¾‹ï¼Œå¯¹è¿™äº›æ–°æ•°æ®è¿›è¡Œå¤„ç†ï¼Œå¹¶ç»™å‡ºä¸€ä¸ªé¢„æµ‹ã€åˆ¤æ–­æˆ–è¾“å‡ºï¼ˆä¾‹å¦‚ï¼Œè¯†åˆ«å‡ºç…§ç‰‡ä¸­çš„ç‰©ä½“ï¼Œæˆ–è€…æ ¹æ®è¾“å…¥çš„æ–‡å­—ç”Ÿæˆä¸€æ®µæ–°çš„æ–‡å­—ï¼‰ã€‚
- æ¨ç†è¿‡ç¨‹é€šå¸¸æ¯”è®­ç»ƒè¿‡ç¨‹å¿«å¾—å¤šï¼Œå¯¹è®¡ç®—èµ„æºçš„è¦æ±‚ä¹Ÿä½å¾—å¤šï¼Œä½¿å…¶å¯ä»¥åœ¨è®¡ç®—èƒ½åŠ›ç›¸å¯¹è¾ƒå¼±çš„è®¾å¤‡ä¸Šè¿è¡Œã€‚

æœ¬å®éªŒçš„æ ¸å¿ƒåœ¨äºâ€œæ¨ç†â€ï¼šæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªå·²ç»è®­ç»ƒå¥½çš„å‹è¯­è¨€æ¨¡å‹ (TinyStory/Qwen)ï¼Œå¹¶åœ¨æˆ‘ä»¬çš„DAYU200å¼€å‘æ¿ä¸Šè¿è¡Œå®ƒï¼Œè®©å®ƒå¯¹æˆ‘ä»¬è¾“å…¥çš„æ–‡æœ¬è¿›è¡Œå¤„ç†å¹¶ç”Ÿæˆå›åº”ã€‚æˆ‘ä»¬ä¸æ¶‰åŠæ¨¡å‹çš„è®­ç»ƒè¿‡ç¨‹ã€‚

## 1.3 ä»€ä¹ˆæ˜¯ AI æ¨ç†æ¡†æ¶ (Inference Framework)ï¼Ÿ

å½“ä½ æœ‰äº†ä¸€ä¸ªè®­ç»ƒå¥½çš„AIæ¨¡å‹åï¼Œè¦åœ¨å®é™…è®¾å¤‡ä¸Šé«˜æ•ˆåœ°è¿è¡Œå®ƒè¿›è¡Œæ¨ç†ï¼Œç›´æ¥æ“ä½œåŸå§‹æ¨¡å‹æ–‡ä»¶å¯èƒ½ä¼šéå¸¸å¤æ‚å’Œä½æ•ˆã€‚è¿™æ—¶ï¼ŒAIæ¨ç†æ¡†æ¶å°±æ´¾ä¸Šäº†ç”¨åœºã€‚

AIæ¨ç†æ¡†æ¶æ˜¯ä¸€å¥—ä¸“é—¨è®¾è®¡ç”¨æ¥ç®€åŒ–å’Œä¼˜åŒ–åœ¨å„ç§ç¡¬ä»¶å¹³å°ä¸Šéƒ¨ç½²å’Œæ‰§è¡Œå·²è®­ç»ƒæ¨¡å‹è¿›è¡Œæ¨ç†çš„è½¯ä»¶å·¥å…·åŒ…æˆ–åº“ã€‚

å®ƒçš„ä¸»è¦ä½œç”¨åŒ…æ‹¬ï¼š

- æ¨¡å‹åŠ è½½ä¸è§£æï¼š èƒ½å¤Ÿè¯»å–å’Œç†è§£ä¸åŒæ ¼å¼çš„è®­ç»ƒå¥½çš„æ¨¡å‹æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒTensorFlowäº§ç”Ÿçš„.pbæ–‡ä»¶ï¼ŒPyTorchçš„.ptæ–‡ä»¶ï¼ŒMindSporeçš„.msæ–‡ä»¶ï¼Œæˆ–è€…åƒLlama.cppä½¿ç”¨çš„.ggufæ ¼å¼ï¼‰ã€‚
- æ€§èƒ½ä¼˜åŒ–ï¼š é’ˆå¯¹ç›®æ ‡ç¡¬ä»¶ï¼ˆå¦‚CPUã€GPUã€NPUâ€”â€”DAYU200ä¸Šå°±æœ‰NPUï¼‰è¿›è¡Œæ·±åº¦ä¼˜åŒ–ï¼Œä»¥åŠ å¿«æ¨ç†é€Ÿåº¦ã€å‡å°‘å†…å­˜å ç”¨å’Œé™ä½åŠŸè€—ã€‚è¿™å¯èƒ½åŒ…æ‹¬å›¾ä¼˜åŒ–ã€ç®—å­èåˆã€é‡åŒ–ã€ä½¿ç”¨ç‰¹å®šç¡¬ä»¶åŠ é€ŸæŒ‡ä»¤ç­‰æŠ€æœ¯ã€‚
- ç¡¬ä»¶æŠ½è±¡ï¼š ä¸ºä¸Šå±‚åº”ç”¨æä¾›ç»Ÿä¸€çš„APIæ¥å£ï¼Œå±è”½åº•å±‚ä¸åŒç¡¬ä»¶çš„å·®å¼‚ã€‚å¼€å‘è€…ä¸éœ€è¦é’ˆå¯¹æ¯ç§ç¡¬ä»¶éƒ½å†™ä¸€å¥—ä¸åŒçš„ä»£ç ã€‚
- è·¨å¹³å°æ”¯æŒï¼š å¾ˆå¤šæ¡†æ¶æ”¯æŒå°†æ¨¡å‹éƒ¨ç½²åˆ°å¤šç§æ“ä½œç³»ç»Ÿï¼ˆWindows, Linux, Android, iOS, OpenHarmonyç­‰ï¼‰å’Œå¤šç§ç¡¬ä»¶æ¶æ„ä¸Šã€‚
- æ˜“ç”¨æ€§ï¼š ç®€åŒ–äº†æ¨¡å‹éƒ¨ç½²çš„æµç¨‹ï¼Œè®©åº”ç”¨å¼€å‘è€…å¯ä»¥æ›´å®¹æ˜“åœ°å°†AIèƒ½åŠ›é›†æˆåˆ°è‡ªå·±çš„åº”ç”¨ä¸­ã€‚

## 1.4 æˆ‘ä»¬å®éªŒä¸­æ¥è§¦åˆ°çš„æ¨ç†å·¥å…·/æ¡†æ¶ï¼š

- Llama.cpp: https://github.com/ggml-org/llama.cpp

  - è¿™æ˜¯ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„å¼€æºé¡¹ç›®ï¼Œä¸“é—¨ç”¨äºåœ¨CPUä¸Šé«˜æ•ˆè¿è¡ŒLlamaç³»åˆ—åŠå…¶ä»–å¤§å‹è¯­è¨€æ¨¡å‹ (LLM)ã€‚
  - å®ƒçš„ä¸»è¦ç‰¹ç‚¹æ˜¯ç”¨çº¯C/C++ç¼–å†™ï¼Œè¿½æ±‚æè‡´çš„æ€§èƒ½å’Œæœ€å°çš„ä¾èµ–ï¼Œéå¸¸é€‚åˆäº¤å‰ç¼–è¯‘åˆ°å„ç§ç«¯ä¾§è®¾å¤‡å’ŒåµŒå…¥å¼ç³»ç»Ÿä¸Šï¼ˆæ¯”å¦‚æˆ‘ä»¬çš„DAYU200ï¼‰ã€‚
  - å®ƒæ”¯æŒå¤šç§é‡åŒ–æŠ€æœ¯ï¼Œå¯ä»¥å°†åŸæœ¬éå¸¸åºå¤§çš„LLMæ¨¡å‹å‹ç¼©åˆ°å‡ GBç”šè‡³å‡ ç™¾MBï¼ŒåŒæ—¶å°½é‡ä¿æŒè¾ƒå¥½çš„æ€§èƒ½ï¼Œä½¿å¾—åœ¨æ™®é€šPCå’Œèµ„æºå—é™çš„è®¾å¤‡ä¸Šè¿è¡ŒLLMæˆä¸ºå¯èƒ½ã€‚
  - åœ¨æœ¬æ¬¡å®éªŒä¸­ï¼Œæˆ‘ä»¬å°†æŠŠLlama.cppç¼–è¯‘æˆä¸€ä¸ªåº“ï¼Œå¹¶åœ¨OpenHarmonyåº”ç”¨ä¸­è°ƒç”¨å®ƒæ¥å®ç°è¯­è¨€æ¨¡å‹çš„æ¨ç†ã€‚

- MindSpore Liteï¼š

  - è¿™æ˜¯åä¸ºæ˜‡æ€MindSpore AIè®¡ç®—æ¡†æ¶çš„è½»é‡åŒ–ç‰ˆæœ¬ï¼Œä¸“é—¨ç”¨äºåœ¨ç«¯ä¾§è®¾å¤‡å’Œç‰©è”ç½‘è®¾å¤‡ä¸Šè¿›è¡Œé«˜æ•ˆæ¨ç†ã€‚
  - æˆ‘ä»¬ä¼šæä¾›ä¸€ä¸ªä½¿ç”¨MindSpore Liteçš„Demoã€‚MindSpore Liteæ”¯æŒå¤šç§ç¡¬ä»¶åç«¯ï¼ˆCPUã€GPUã€ä»¥åŠåä¸ºè‡ªç ”çš„NPUï¼‰ï¼Œèƒ½å¤ŸåŠ è½½MindSporeè®­ç»ƒå‡ºçš„æ¨¡å‹ï¼ˆ.msæ ¼å¼ï¼‰ä»¥åŠè½¬æ¢è‡ªå…¶ä»–æ¡†æ¶ï¼ˆå¦‚TensorFlow Liteã€ONNXï¼‰çš„æ¨¡å‹ã€‚
  - å®ƒæä¾›äº†Javaå’ŒC++ç­‰å¤šç§è¯­è¨€çš„APIï¼Œæ–¹ä¾¿å¼€å‘è€…åœ¨Androidã€iOSã€OpenHarmonyç­‰ç³»ç»Ÿä¸Šé›†æˆAIèƒ½åŠ›ã€‚

å¯ä»¥æŠŠæ¨ç†æ¡†æ¶æƒ³è±¡æˆä¸€ä¸ªé«˜åº¦ä¸“ä¸šçš„â€œå¼•æ“å®¤ç®¡ç†å‘˜â€ï¼Œå®ƒçŸ¥é“å¦‚ä½•æœ€é«˜æ•ˆåœ°å¯åŠ¨å’Œè¿è¡Œä¸€ä¸ªå¤æ‚çš„â€œAIå¼•æ“â€ï¼ˆå³è®­ç»ƒå¥½çš„æ¨¡å‹ï¼‰ï¼Œå¹¶ç¡®ä¿å®ƒåœ¨ç‰¹å®šçš„â€œèˆ¹åªâ€ï¼ˆå³ä½ çš„ç¡¬ä»¶è®¾å¤‡ï¼‰ä¸Šè¡¨ç°æœ€ä½³ã€‚



## 1.5 ç«¯ä¾§ AI (On-Device AI)æ¨ç† ä¸åº”ç”¨å¼€å‘ç®€ä»‹

### 1.5.1 ä»€ä¹ˆæ˜¯ç«¯ä¾§AIæ¨ç†ï¼Ÿ

â€œç«¯ä¾§AIâ€ (On-Device AI æˆ– Edge AI) æŒ‡çš„æ˜¯ç›´æ¥åœ¨ç»ˆç«¯ç”¨æˆ·è®¾å¤‡ï¼ˆå¦‚æ™ºèƒ½æ‰‹æœºã€å¹³æ¿ç”µè„‘ã€æ™ºèƒ½æ‰‹è¡¨ã€ç‰©è”ç½‘è®¾å¤‡ã€æˆ–è€…æˆ‘ä»¬å®éªŒä¸­çš„DAYU200å¼€å‘æ¿ï¼‰ä¸Šæœ¬åœ°æ‰§è¡ŒAIæ¨¡å‹çš„æ¨ç†è¿‡ç¨‹ï¼Œè€Œä¸æ˜¯å°†æ•°æ®å‘é€åˆ°è¿œç¨‹çš„äº‘æœåŠ¡å™¨è¿›è¡Œå¤„ç†ã€‚

> è¿™ä¹Ÿæ˜¯æˆ‘ä»¬è¯¾é¢˜ç»„çš„ä¸€ä¸ªç ”ç©¶æ–¹å‘ï¼Œæ¬¢è¿æ„Ÿå…´è¶£çš„åŒå­¦è”ç³»[ææ°¸å¤è€å¸ˆ](http://staff.ustc.edu.cn/~ykli/)ï¼Œç„¶ååŠ å…¥æˆ‘ä»¬(â—'â—¡'â—)

### 1.5.2 ç«¯ä¾§AIæ¨ç†çš„ä¼˜åŠ¿

- ä½å»¶è¿Ÿ (Low Latency)ï¼š æ•°æ®å¤„ç†åœ¨æœ¬åœ°è¿›è¡Œï¼Œæ— éœ€ç½‘ç»œä¼ è¾“ï¼Œå“åº”é€Ÿåº¦æ›´å¿«ï¼Œå¯¹äºéœ€è¦å®æ—¶åé¦ˆçš„åº”ç”¨ï¼ˆå¦‚å®æ—¶è¯­éŸ³è¯†åˆ«ã€åŠ¨æ€æ‰‹åŠ¿è¯†åˆ«ï¼‰è‡³å…³é‡è¦ã€‚
- éšç§ä¿æŠ¤ (Privacy Protection)ï¼š æ•æ„Ÿæ•°æ®ï¼ˆå¦‚ä¸ªäººç…§ç‰‡ã€å½•éŸ³ï¼‰æ— éœ€ä¸Šä¼ åˆ°äº‘ç«¯ï¼Œä¿ç•™åœ¨ç”¨æˆ·æœ¬åœ°è®¾å¤‡ä¸Šï¼Œæ›´å¥½åœ°ä¿æŠ¤äº†ç”¨æˆ·éšç§ã€‚
- ç¦»çº¿å¯ç”¨ (Offline Capability)ï¼š å³ä½¿åœ¨æ²¡æœ‰ç½‘ç»œè¿æ¥æˆ–ç½‘ç»œä¸ç¨³å®šçš„æƒ…å†µä¸‹ï¼ŒAIåŠŸèƒ½ä¾ç„¶å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚
- èŠ‚çœå¸¦å®½ä¸æˆæœ¬ (Bandwidth & Cost Saving)ï¼š å‡å°‘äº†å¤§é‡æ•°æ®ä¸Šä¼ ä¸‹è½½æ‰€éœ€çš„ç½‘ç»œå¸¦å®½ï¼Œä¹Ÿå¯èƒ½é™ä½äº†å¯¹äº‘ç«¯è®¡ç®—èµ„æºçš„ä¾èµ–ï¼Œä»è€ŒèŠ‚çœæˆæœ¬ã€‚

> å…¶å®æœ€ä¸»è¦çš„æ˜¯çœé’±ğŸ’´è¿˜æœ‰éšç§ä¿æŠ¤ã€‚

### 1.5.3 ç«¯ä¾§AIæ¨ç†çš„æŒ‘æˆ˜ï¼š

- èµ„æºé™åˆ¶ï¼š ç«¯ä¾§è®¾å¤‡çš„è®¡ç®—èƒ½åŠ›ï¼ˆCPUã€GPUã€NPUæ€§èƒ½ï¼‰ã€å†…å­˜ã€å­˜å‚¨ç©ºé—´ä»¥åŠç”µæ± ç»­èˆªéƒ½è¿œä¸å¦‚äº‘æœåŠ¡å™¨ã€‚
- æ¨¡å‹å¤§å°ä¸æ•ˆç‡ï¼š éœ€è¦å¯¹AIæ¨¡å‹è¿›è¡Œé«˜åº¦ä¼˜åŒ–å’Œå‹ç¼©ï¼ˆå¦‚é‡åŒ–ï¼‰ï¼Œä½¿å…¶èƒ½å¤Ÿåœ¨èµ„æºå—é™çš„è®¾å¤‡ä¸Šé«˜æ•ˆè¿è¡Œï¼ŒåŒæ—¶å°½é‡ä¸æŸå¤±å¤ªå¤šç²¾åº¦ã€‚

> åœ¨æœ¬æ¬¡å®éªŒä¸­ï¼Œæˆ‘ä»¬å°†ä½“éªŒåˆ°é‡åŒ–å¯¹æ¨¡å‹å¤§å°å’Œæ€§èƒ½çš„å½±å“,ä¹Ÿä¼šä½“ä¼šåˆ°å†…å­˜å’Œè®¡ç®—èƒ½åŠ›å¸¦æ¥çš„é™åˆ¶ã€‚

### 1.5.4 ç«¯ä¾§AIåº”ç”¨å¼€å‘æµç¨‹ï¼ˆç®€åŒ–ç‰ˆï¼‰

1. é€‰æ‹©æˆ–è®­ç»ƒAIæ¨¡å‹ï¼š æ ¹æ®åº”ç”¨éœ€æ±‚é€‰æ‹©åˆé€‚çš„é¢„è®­ç»ƒæ¨¡å‹ï¼ˆä¾‹å¦‚ï¼Œæ˜¯å›¾åƒåˆ†ç±»ã€ç›®æ ‡æ£€æµ‹ã€è¿˜æ˜¯è‡ªç„¶è¯­è¨€ç†è§£ï¼‰ã€‚åœ¨æœ¬æ¬¡å®éªŒä¸­ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨å·²ç»è®­ç»ƒå¥½çš„TinyStoriesæ¨¡å‹ã€‚
2. ä¼˜åŒ–ä¸é‡åŒ–ï¼š å¯¹æ¨¡å‹è¿›è¡Œé‡åŒ–ï¼ˆå¦‚INT8é‡åŒ–ï¼‰ï¼Œå‡å°æ¨¡å‹å¤§å°ï¼Œæé«˜åœ¨ç«¯ä¾§è®¾å¤‡ä¸Šçš„è¿è¡Œæ•ˆç‡ã€‚
3. åº”ç”¨é›†æˆä¸å¼€å‘ï¼š

  - åœ¨ä½ çš„åº”ç”¨ç¨‹åºä»£ç ä¸­ï¼ˆå¯¹äºLlama.cppï¼Œæˆ‘ä»¬å°†åœ¨C++å±‚é¢æ“ä½œï¼‰ï¼Œè°ƒç”¨æ¨ç†æ¡†æ¶æä¾›çš„APIï¼š
  - åŠ è½½ä¼˜åŒ–åçš„æ¨¡å‹æ–‡ä»¶ã€‚
  - å‡†å¤‡è¾“å…¥æ•°æ®ï¼ˆä¾‹å¦‚ï¼Œå¯¹å›¾åƒè¿›è¡Œé¢„å¤„ç†ï¼Œæˆ–å°†ç”¨æˆ·æ–‡æœ¬ç¼–ç æˆæ¨¡å‹éœ€è¦çš„æ ¼å¼ï¼‰ã€‚
  - æ‰§è¡Œæ¨ç†ï¼Œè·å–æ¨¡å‹è¾“å‡ºã€‚
  - å¯¹æ¨¡å‹è¾“å‡ºè¿›è¡Œåå¤„ç†ï¼Œå¹¶å‘ˆç°ç»™ç”¨æˆ·æˆ–ç”¨äºåç»­é€»è¾‘ã€‚

> åœ¨æœ¬æ¬¡å®éªŒä¸­ï¼Œæˆ‘ä»¬å°†ä¼šæä¾›å®Œæ•´çš„æ¨ç†ä»£ç ï¼ŒåŒå­¦ä»¬åªéœ€è¦ç¼–è¯‘å‡ºæ¨ç†æ¡†æ¶Llama.cppçš„åŠ¨æ€é“¾æ¥åº“æ”¾åˆ°é¡¹ç›®ä»£ç ä¸­å³å¯ï¼Œå¦‚æœä½ å¯¹æ¨ç†çš„å…·ä½“é€»è¾‘æ„Ÿå…´è¶£ï¼Œä¹Ÿå¯ä»¥é˜…è¯»æºä»£ç æ¥è°ƒæ•´åº”ç”¨çš„é€»è¾‘ã€‚


<div STYLE="page-break-after: always;"></div>

## é™„å½•B: ç¼–å†™è‡ªå·±çš„åº“

ç¬¬ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨ä¸€ä¸ªç¬¬ä¸‰æ–¹åŠ¨æ€é“¾æ¥åº“ã€‚åŒå­¦ä»¬å¯èƒ½ä¼šå¥½å¥‡ï¼Œæˆ‘ä»¬å¦‚ä½•ç¼–å†™è‡ªå·±çš„åº“ï¼Œå¹¶å‘å¸ƒç»™åˆ«äººå‘¢ï¼Ÿæœ¬èŠ‚é™„å½•å°±æ¥ç®€å•ä»‹ç»è¯¥è¿‡ç¨‹ã€‚ä¸ºäº†ä½œä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†æ¼”ç¤ºå¦‚ä½•ç¼–å†™åªåŒ…å«ä¸€ä¸ªå‡½æ•°`minus_numbers_in_lib`çš„åº“`mylib`ã€‚

ä¸ºäº†å®ç°è¯¥åº“ï¼Œæˆ‘ä»¬éœ€è¦ä¸¤ä¸ªæ–‡ä»¶`mylib.cpp`å’Œ`mylib.h`ï¼Œå‰è€…æä¾›å‡½æ•°çš„å®ç°ï¼Œåè€…å®šä¹‰å‡½æ•°çš„æ¥å£ã€‚

1. åˆ›å»ºæºä»£ç æ–‡ä»¶ï¼š
   æ‰“å¼€ç»ˆç«¯ï¼Œåˆ›å»ºä¸€ä¸ªåä¸º`mylib.cpp`çš„æ–‡ä»¶ï¼Œåœ¨è¯¥æ–‡ä»¶ä¸­ç¼–å†™ä¸€ä¸ªç®€å•çš„å‡æ³•å‡½æ•°å¦‚ä¸‹ï¼š

    ```cpp
   // ä½¿ç”¨ extern "C" å¯ä»¥é˜²æ­¢ C++ ç¼–è¯‘å™¨çš„åç§°ä¿®é¥° (name mangling),
   // ä½¿å¾—è¿™äº›å‡½æ•°æ›´å®¹æ˜“è¢« C è¯­è¨€æˆ–å…¶ä»–è¯­è¨€è°ƒç”¨, æˆ–è€…åœ¨ä¸åŒ C++ ç¼–è¯‘å™¨é—´ä¿æŒä¸€è‡´æ€§ã€‚
   // å¯¹äºçº¯ C++ å†…éƒ¨ä½¿ç”¨, ä¸”ä¸»ç¨‹åºä¹Ÿç”¨åŒä¸€ç¼–è¯‘å™¨ç¼–è¯‘æ—¶, è¿™å¹¶éæ€»æ˜¯å¿…éœ€, ä½†ä½œä¸ºåº“å¯¼å‡ºæ˜¯ä¸€ç§è‰¯å¥½å®è·µã€‚
   extern "C" {
       double minus_numbers_in_lib(double a,double b) {
           return a - b;
       }
   }
    ```

2. ä¸ºåº“åˆ›å»ºå¤´æ–‡ä»¶(mylib.h):

   åœ¨åŒä¸€æ–‡ä»¶å¤¹åˆ›å»º`mylib.h`ï¼Œå£°æ˜åº“ä¸­çš„å‡½æ•°:

   ```cpp
   #ifndef MYLIB_H
   #define MYLIB_H
   
   #ifdef __cplusplus
   extern "C" {
   #endif
   
   // å£°æ˜åº“ä¸­å¯¼å‡ºçš„å‡½æ•°
   double minus_numbers_in_lib(double a,double b)
   
   #ifdef __cplusplus
   }
   #endif
   
   #endif // MYLIB_H
   ```

3. å°†æºä»£ç äº¤å‰ç¼–è¯‘ä¸ºåŠ¨æ€é“¾æ¥åº“ (.so æ–‡ä»¶):

   ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å³å¯ï¼š

   ```bash
   g++ -shared -fPIC mylib.cpp -o libmylib.so
   ```

   ä¸ºäº†è®©å…¶ä»–äººæ›´æ–¹ä¾¿ä½¿ç”¨ä½ çš„åº“ï¼Œä½ å¯ä»¥å°†è¯¥ç¼–è¯‘è¿‡ç¨‹å†™å…¥`Makefile`ã€‚å½“ä½ çš„åº“æ›´å¤æ‚ï¼Œæœ‰ç€æ›´å¤šé…ç½®é€‰é¡¹æ—¶ï¼Œä½ å¯ä»¥ç¼–å†™`CMakeLists.txt`è®©`cmake`ä¸ºä½ ç”Ÿæˆ`Makefile`ã€‚å½“ç„¶ï¼Œä½ è¿˜å¯ä»¥è®© AI æ¥å¸®ä½ ç¼–å†™`CMakeLists.txt`â€¦â€¦ï¼ˆå¥—å¨ƒä¸­ï¼‰ã€‚

   `Makefile`ã€`CMakeLists.txt`ç­‰çš„ç¼–å†™è¶…å‡ºäº†è®¨è®ºèŒƒå›´ï¼Œä½ å¯ä»¥è‡ªè¡ŒæŸ¥è¯¢ã€‚



## é™„å½•C: llama-Demo.cppä»£ç è¯´æ˜

æœ¬é™„å½•æ—¨åœ¨ç®€è¦ä»‹ç»å®éªŒä¸­æä¾›çš„ llama-Demo.cpp ç¤ºä¾‹ç¨‹åºã€‚è¿™ä¸ªç¨‹åºæ˜¯ä¸€ä¸ªåŸºäºå‘½ä»¤è¡Œçš„C++åº”ç”¨ï¼Œå®ƒè°ƒç”¨ Llama.cpp åº“ï¼ˆå³æˆ‘ä»¬ç¼–è¯‘çš„ libllama.soï¼‰æ¥åŠ è½½ä¸€ä¸ªå¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰ï¼Œå¹¶æ ¹æ®ç”¨æˆ·è¾“å…¥çš„æç¤ºï¼ˆpromptï¼‰è¿›è¡Œæ–‡æœ¬æ¨ç†ç”Ÿæˆã€‚

ç†è§£è¿™ä¸ªç¤ºä¾‹ç¨‹åºçš„å·¥ä½œæµç¨‹æœ‰åŠ©äºæˆ‘ä»¬äº†è§£å¦‚ä½•é€šè¿‡APIä¸ç¬¬ä¸‰æ–¹åº“è¿›è¡Œäº¤äº’ï¼Œä»¥å®ç°å¤æ‚çš„åŠŸèƒ½ã€‚

### ä¸»è¦å‡½æ•°è¯´æ˜

ä»¥ä¸‹æ˜¯å¯¹ llama-Demo.cpp ä¸­å…³é”®å‡½æ•°åŠŸèƒ½çš„ç®€è¦è¯´æ˜ã€‚ä¸ºç®€æ´èµ·è§ï¼Œéƒ¨åˆ†å®ç°ç»†èŠ‚å°†ç”¨ ... è¡¨ç¤ºã€‚

- å¤´æ–‡ä»¶å¯¼å…¥

  ```cpp
  #include "llama.h" // å¼•å…¥Llama.cppåº“çš„å…¬å…±å¤´æ–‡ä»¶
  
  #include <cstdio>   // ç”¨äºæ ‡å‡†è¾“å…¥è¾“å‡ºï¼Œå¦‚printf
  #include <cstring>  // ç”¨äºå­—ç¬¦ä¸²æ“ä½œï¼Œå¦‚strcmp
  #include <string>   // ç”¨äºstd::stringç±»
  #include <vector>   // ç”¨äºstd::vectorç±»
  ```

- æ‰“å°ç¨‹åºä½¿ç”¨æ–¹æ³•ä¸å‘½ä»¤è¡Œå‚æ•°è§£æ

  ```cpp
  // æ‰“å°ç¨‹åºä½¿ç”¨æ–¹æ³•
  static void print_usage(int, char ** argv) {
      ...
  }
  
  // è§£æå‘½ä»¤è¡Œå‚æ•°
  void ParseArgs(int argc, char** argv, 
              std::string& model_path, std::string& prompt, int& n_predict){
                  ...
  }
  ```

- åŠ è½½GGUFæ¨¡å‹æ–‡ä»¶

  ```cpp
  llama_model* LoadModel(const std::string& model_path) {
      // è®¾ç½®æ¨¡å‹åŠ è½½å‚æ•°
      llama_model_params model_params = llama_model_default_params();
      // model_params.n_gpu_layers = 0; // å¯è®¾ç½®GPUå±‚æ•°ï¼Œ0è¡¨ç¤ºçº¯CPUã€‚ä»£ç ä¸­æ˜¯99ï¼Œè¡¨ç¤ºå°è¯•å…¨GPUã€‚
      model_params.n_gpu_layers = 99; 
      // åŠ è½½æ¨¡å‹
      llama_model* model = llama_model_load_from_file(model_path.c_str(), model_params);
      if (model == nullptr) {
          fprintf(stderr, "%s: error: unable to load model from '%s'\n", __func__, model_path.c_str());
          exit(1); // åŠ è½½å¤±è´¥åˆ™é€€å‡º
      }
      printf("Model loaded successfully: %s\n", model_path.c_str());
      return model;
  }
  ```

- å¯¹ç”¨æˆ·æç¤ºè¿›è¡Œåˆ†è¯ (Tokenization)ã€‚

  ```cpp
  std::vector<llama_token> TokenizePrompt(const llama_vocab* vocab, const std::string& prompt) {
      // å…ˆä¼°ç®—æœ€å¤§tokenæ•°é‡ï¼Œç„¶åå®é™…è¿›è¡Œåˆ†è¯
      // llama_tokenizeçš„å‚æ•°: vocab, è¾“å…¥å­—ç¬¦ä¸², é•¿åº¦, è¾“å‡ºbuffer, bufferå¤§å°, æ˜¯å¦åŠ BOS, æ˜¯å¦ç‰¹æ®Šå¤„ç†
      // ... (å¦‚ä»£ç ä¸­æ‰€ç¤ºï¼Œå…ˆè°ƒç”¨ä¸€æ¬¡è·å–é•¿åº¦ï¼Œå†è°ƒç”¨ä¸€æ¬¡å¡«å……) ...
      const int n_tokens_estimated = -llama_tokenize(vocab, prompt.c_str(), prompt.size(), nullptr, 0, true, true);
      std::vector<llama_token> prompt_tokens(n_tokens_estimated);
      int n_tokens_actual = llama_tokenize(vocab, prompt.c_str(), prompt.size(), prompt_tokens.data(), prompt_tokens.size(), true, true);
  
      if (n_tokens_actual < 0 || n_tokens_actual > n_tokens_estimated ) { // å‡ºé”™æˆ–æ•°é‡ä¸å¯¹
          fprintf(stderr, "%s: error: failed to tokenize the prompt or size mismatch\n", __func__);
          exit(1);
      }
      prompt_tokens.resize(n_tokens_actual); // è°ƒæ•´ä¸ºå®é™…tokenæ•°
      return prompt_tokens;
  }
  ```

- åˆå§‹åŒ–ä¸Šä¸‹æ–‡ä¸é‡‡æ ·å™¨

  ```cpp
  // åˆå§‹åŒ–æ¨ç†ä¸Šä¸‹æ–‡(context)
  llama_context* InitializeContext(llama_model* model, int n_prompt_tokens, int n_predict) {
      llama_context_params ctx_params = llama_context_default_params();
      // è®¾ç½®ä¸Šä¸‹æ–‡çª—å£å¤§å°ï¼Œå¿…é¡»èƒ½å®¹çº³æç¤ºå’Œç”Ÿæˆçš„æœ€å¤§tokenæ•°
      ctx_params.n_ctx = n_prompt_tokens + n_predict; 
      ctx_params.n_batch = n_prompt_tokens; // åˆå§‹æ‰¹å¤„ç†å¤§å°å¯ä»¥è®¾ä¸ºæç¤ºçš„é•¿åº¦
      // ... 
      ctx_params.no_perf = false; // å¼€å¯æ€§èƒ½è®¡æ•°
  
      llama_context* ctx = llama_init_from_model(model, ctx_params);
      if (ctx == nullptr) {
          fprintf(stderr, "%s: error: unable to create Llama context\n", __func__);
          exit(1);
      }
      return ctx;
  }
  
  // åˆå§‹åŒ–é‡‡æ ·å™¨(sampler)
  llama_sampler* InitializeSampler() {
      auto sparams = llama_sampler_chain_default_params();
      sparams.no_perf = false; // å¼€å¯æ€§èƒ½è®¡æ•°
      // ... (å¯ä»¥ä¿®æ”¹sparamsæ¥è°ƒæ•´é‡‡æ ·ç­–ç•¥ï¼Œä¾‹å¦‚æ¸©åº¦ã€top_k, top_pç­‰) ...
      llama_sampler* smpl = llama_sampler_chain_init(sparams);
      if (smpl == nullptr) {
          fprintf(stderr, "%s: error: Failed to create sampler chain\n", __func__);
          exit(1);
      }
      // å‘é‡‡æ ·é“¾ä¸­æ·»åŠ ä¸€ä¸ªè´ªå¿ƒé‡‡æ ·å™¨ (æ€»æ˜¯é€‰æ‹©æ¦‚ç‡æœ€é«˜çš„token)
      // ä¹Ÿå¯ä»¥æ·»åŠ å…¶ä»–é‡‡æ ·å™¨ï¼Œå¦‚ llama_sampler_init_top_k(), llama_sampler_init_top_p() ç­‰
      llama_sampler_chain_add(smpl, llama_sampler_init_greedy());
      return smpl;
  }
  ```

- æ–‡æœ¬ç”Ÿæˆå‡½æ•°

  ```cpp
  void GenerateTokens(std::vector<llama_token>& prompt_tokens, llama_context* ctx,
                      const llama_vocab* vocab, llama_sampler* smpl, 
                      int n_prompt /*åˆå§‹æç¤ºtokenæ•°*/, int n_predict /*è¦ç”Ÿæˆçš„æœ€å¤§tokenæ•°*/) {
  
      // 1. å‡†å¤‡åŒ…å«æç¤ºçš„åˆå§‹æ‰¹å¤„ç† (batch)
      llama_batch batch = llama_batch_get_one(prompt_tokens.data(), n_prompt, 0, 0); 
      int n_current_pos = 0; // å½“å‰åºåˆ—ä¸­å·²å¤„ç†ï¼ˆè§£ç ï¼‰çš„tokenæ•°é‡
  
      // 2. ä¸»ç”Ÿæˆå¾ªç¯
      // å¾ªç¯ç›´åˆ°è¾¾åˆ°é¢„æµ‹é•¿åº¦ï¼Œæˆ–è€…é‡åˆ°åºåˆ—ç»“æŸç¬¦(EOG)ï¼Œæˆ–è€…è§£ç å¤±è´¥
      // ä»£ç ä¸­å¾ªç¯æ¡ä»¶æ˜¯: n_pos + batch.n_tokens < n_prompt + n_predict
      // è¿™é‡Œçš„n_posåœ¨ä»£ç ä¸­æ˜¯å¤–éƒ¨å¾ªç¯å˜é‡ï¼Œä¸batch.n_tokensç»“åˆæ§åˆ¶æ€»é•¿åº¦ã€‚
      for (int n_pos = 0; n_pos + batch.n_tokens < n_prompt + n_predict; ) {
          // 2a. è§£ç å½“å‰æ‰¹æ¬¡ (å¤„ç†tokens)
          // ç¬¬ä¸€æ¬¡å¾ªç¯æ—¶ï¼Œbatchä¸­æ˜¯å®Œæ•´çš„promptï¼›åç»­å¾ªç¯æ—¶ï¼Œbatchä¸­æ˜¯ä¸Šä¸€æ­¥ç”Ÿæˆçš„å•ä¸ªtokenã€‚
          if (llama_decode(ctx, batch) != 0) { // è¿”å›0ä»£è¡¨æˆåŠŸ
              fprintf(stderr, "%s : failed to eval tokens, return code %d\n", __func__, 1);
              break; 
          }
          n_pos += batch.n_tokens; // æ›´æ–°å·²å¤„ç†çš„tokenæ€»æ•°
  
          // 2b. ä»æ¨¡å‹è¾“å‡ºä¸­é‡‡æ ·ä¸‹ä¸€ä¸ªtoken
          llama_token new_token_id = llama_sampler_sample(smpl, ctx, -1); // -1è¡¨ç¤ºä»å½“å‰ä¸Šä¸‹æ–‡æœ€åä¸€ä¸ªæœ‰æ•ˆtokençš„logitsé‡‡æ ·
  
          // 2c. æ£€æŸ¥æ˜¯å¦æ˜¯ç”Ÿæˆç»“æŸæ ‡è®° (End Of Generation)
          if (llama_vocab_is_eog(vocab, new_token_id)) {
              // printf("\n[EOG]"); // é‡åˆ°ç»“æŸç¬¦ï¼Œåœæ­¢ç”Ÿæˆ
              break;
          }
  
          // 2d. å°†æ–°ç”Ÿæˆçš„tokenè½¬æ¢ä¸ºæ–‡æœ¬å¹¶æ‰“å°
          char buf[128];
          int n = llama_token_to_piece(vocab, new_token_id, buf, sizeof(buf), 0, true);
          if (n < 0) {
              fprintf(stderr, "%s: error: failed to convert token to piece\n", __func__);
          }
          std::string s(buf, n);
          printf("%s", s.c_str());
          fflush(stdout);
          // 2e. å‡†å¤‡ä¸‹ä¸€ä¸ªæ‰¹å¤„ç†ï¼ŒåªåŒ…å«æ–°ç”Ÿæˆçš„tokenï¼Œç”¨äºä¸‹ä¸€æ¬¡è¿­ä»£
          batch = llama_batch_get_one(&new_token_id, 1);
      }
  }
  ```

## é™„å½•D: Native C++ åº”ç”¨ä¸­ C++ å‡½æ•°å®šä¹‰

æˆ‘ä»¬åœ¨æ­£æ–‡ä¸­è°ƒç”¨äº† add å‡½æ•°ï¼Œå·ç§°å…¶ä¼šè°ƒç”¨å®ç°åœ¨ `entry/src/main/cpp`é‡Œçš„åŠ æ³•å‡½æ•°ã€‚å¯å…·ä½“æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ

å¦‚æ­£æ–‡æ‰€è¯´ï¼Œé¡¹ç›®C++ç›¸å…³ä»£ç ï¼Œå­˜æ”¾åœ¨`entry/src/main/cpp`ç›®å½•ä¸­ï¼ŒæŸ¥çœ‹è¯¥ç›®å½•ï¼Œå‘ç°ç›®å½•ä¸‹æœ‰åå«`napi_init.cpp`çš„C++æ–‡ä»¶ã€‚æ‰“å¼€æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼ˆçœç•¥éƒ¨åˆ†å†…å®¹ï¼‰ï¼š

```cpp
#include "napi/native_api.h"

static napi_value Add(napi_env env, napi_callback_info info)
{
	// ...
    return sum;
}

EXTERN_C_START
static napi_value Init(napi_env env, napi_value exports)
{
    napi_property_descriptor desc[] = {
        { "add", nullptr, Add, nullptr, nullptr, nullptr, napi_default, nullptr }
    };
    napi_define_properties(env, exports, sizeof(desc) / sizeof(desc[0]), desc);
    return exports;
}
EXTERN_C_END

// ...

```

æ–‡ä»¶é‡Œæœ‰ä¸¤ä¸ªå¥‡æ€ªçš„å‡½æ•°ï¼Œä¸€ä¸ªå«`Add`ï¼Œçœ‹åå­—æ˜¯ä¸ªåŠ æ³•ï¼Œä½†å†…å®¹å¾ˆå¤æ‚ï¼Œå‚æ•°å’Œè¿”å›å€¼éƒ½çœ‹ä¸æ˜ç™½ã€‚ä¸€ä¸ªå«`Init`åªçœ‹å¾—å‡ºé‡Œé¢æœ‰ä¸€è¡Œ`"add"`ä»€ä¹ˆçš„ã€‚

å®é™…ä¸Šï¼Œè¿™é‡Œçš„`Add`å‡½æ•°ï¼Œå°±æ˜¯æˆ‘ä»¬å®é™…è°ƒç”¨çš„ C++ å‡½æ•°ã€‚è€Œ`Init`å‡½æ•°ä¸­çš„ä¸‹é¢è¿™è¡Œï¼Œå°±æ˜¯å‘Šè¯‰åº”ç”¨ï¼Œ`"add"`è¿™ä¸ª`ArkTS`å‡½æ•°ï¼Œå¯¹åº”åˆ°äº†`Add`è¿™ä¸ªC++å‡½æ•°ã€‚

```cpp
// è¿™ä¸ªæ•°ç»„æ˜¯ napi_property_descriptor ç»“æ„ä½“æ•°ç»„
// æ¯ä¸€è¡Œä»£è¡¨ä¸€ä¸ªArkTSå‡½æ•°å’ŒC++å‡½æ•°çš„æ˜ å°„ã€‚å…¶å®ƒåœ°æ–¹æˆ‘ä»¬ä¸ç®¡ï¼Œç¬¬ä¸€ä¸ª"add"ä»£è¡¨ArkTSå‡½æ•°çš„åå­—ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œç¬¬ä¸‰ä¸ª"Add"ä»£è¡¨C++å‡½æ•°ï¼ˆä¸æ˜¯å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯å‡½æ•°åï¼Œæˆ–è€…ç›¸å½“äºå‡½æ•°æŒ‡é’ˆã€‚ï¼‰
    napi_property_descriptor desc[] = {
        { "add", nullptr, Add, nullptr, nullptr, nullptr, napi_default, nullptr }
    };
```



å†ä»”ç»†çœ‹`Add`å‡½æ•°çš„å†…éƒ¨ï¼Œè°ƒç”¨äº†å¾ˆå¤š`napi_`å¼€å¤´çš„å‡½æ•°ã€‚å®é™…ä¸Šï¼Œè¿™äº›å‡½æ•°å°±æ˜¯è´Ÿè´£æŠŠ`add`å‡½æ•°çš„ArkTSæ ¼å¼çš„å‚æ•°ï¼Œè½¬æ¢æˆC++èƒ½å¤Ÿè¯»å–çš„å‚æ•°ã€‚ä¾‹å¦‚ï¼š

```cpp
    double value0;
    napi_get_value_double(env, args[0], &value0);
```

è¿™ä¸¤è¡Œï¼Œå°†`add`å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆ`args[0]`ï¼‰ï¼Œè½¬æ¢ä¸ºC++ä¸­çš„`double`ï¼Œå¹¶å­˜æ”¾åœ¨`value0`å˜é‡ä¸­ã€‚

è€Œä¸‹é¢ä¸¤è¡Œç›¸åï¼š

```cpp
    napi_value sum;
    napi_create_double(env, value0 + value1, &sum);
```

åˆ›å»ºä¸€ä¸ªç±»å‹ä¸º`double`çš„ArkTSå˜é‡`sum`ï¼Œå°†`value0 + value1`çš„å€¼ï¼Œå­˜å…¥`sum`ä¸­ã€‚ï¼ˆåç»­è¯¥å€¼è¢«è¿”å›ï¼Œä½œä¸º`add`å‡½æ•°è°ƒç”¨çš„ç»“æœã€‚ï¼‰

> å¦‚æœä½ è¿˜å¥½å¥‡ï¼Œè¿™äº›è½¬æ¢æ˜¯æ€ä¹ˆè¿›è¡Œçš„ã€‚ä½ å¯ä»¥å‘ç°ï¼Œè¿™äº›å‡½æ•°éƒ½æ˜¯`napi_`å¼€å¤´çš„ï¼Œæ˜¯ä¸æ˜¯å’Œæˆ‘ä»¬ç”¨çš„`llama_`ç³»åˆ—å‡½æ•°æœ‰ç‚¹åƒï¼Ÿå¯¹çš„ï¼Œè¿™ä¸ªC++æ–‡ä»¶å¼•ç”¨äº†`#include "napi/native_api.h"`è¿™ä¸ªå¤´æ–‡ä»¶ã€‚è¿™å®é™…ä¸Šæ˜¯OpenHarmonyæä¾›çš„Native APIåº“çš„ä¸€éƒ¨åˆ†ã€‚è¿™ä¸ªC++æ–‡ä»¶ï¼Œå®é™…ä¸Šå°±æ˜¯è°ƒç”¨äº†OpenHarmony SDKä¸­çš„ Native API åº“ä¸­çš„å‡½æ•°ï¼Œå®ç°äº† C++ å˜é‡å’ŒArkTSå˜é‡é—´çš„è½¬æ¢ã€‚
>
> è‡³äºå…·ä½“è½¬æ¢çš„åŸç†ï¼Œä½œä¸ºåº“çš„ä½¿ç”¨è€…ï¼Œæˆ‘ä»¬æ˜¯ä¸éœ€è¦æŒæ¡çš„ã€‚è¿™å°±æ˜¯è°ƒç”¨åº“çš„å¥½å¤„ã€‚

å®é™…ä¸Šï¼Œåªåœ¨C++ä¸­å®šä¹‰è¿™ä¸ªå‡½æ•°è¿˜ä¸è¡Œï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨ArkTSä¸­å£°æ˜è¿™ä¸ªå‡½æ•°å­˜åœ¨ï¼Œè¿™éƒ¨åˆ†ä»£ç åœ¨`entry/src/main/cpp/types/libentry/Index.d.ts`æ–‡ä»¶ä¸­ï¼Œåªæœ‰ä¸€è¡Œï¼š

```typescript
export const add: (a: number, b: number) => number;
```

è¿™é‡Œæ˜¯ArkTSçš„å‡½æ•°å®šä¹‰çš„è¯­æ³•ï¼Œè¯´æ˜æˆ‘ä»¬â€œå¯¼å‡ºâ€äº†ä¸€ä¸ª`add`å‡½æ•°ï¼Œæœ‰ä¸¤ä¸ªå‚æ•°`a`å’Œ`b`ï¼Œå®ƒä»¬éƒ½æ˜¯æ•°å­—ï¼Œå‡½æ•°çš„è¿”å›å€¼ä¹Ÿæ˜¯æ•°å­—ã€‚ç®€å•è¯´ï¼Œè¿™è¡Œç±»ä¼¼ä¸‹é¢çš„Cä»£ç ï¼š

```c
extern const int add(int a, int b);
```

æ˜¯ä¸æ˜¯ç†è§£äº†å‘¢ï¼Ÿå°±æ˜¯å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°ç½¢äº†ã€‚

è¿™æ ·ä¸¤è¾¹éƒ½å®šä¹‰ä¹‹åï¼Œé€šè¿‡NAPIåº“åœ¨åå°çš„ä¸€ç³»åˆ—æ“ä½œï¼Œå°±èƒ½å®ç°ArkTSåº”ç”¨è°ƒç”¨C++å•¦ï¼

## é™„å½•E: llama.cppçš„ä½¿ç”¨

æˆ‘ä»¬åœ¨å®éªŒä¸­ä¸ºäº†å®éªŒçš„ä½“éªŒï¼Œä½¿ç”¨äº†æå°çš„å°æ•…äº‹æ–‡æœ¬ç”Ÿæˆæ¨¡å‹ï¼Œåå­—å«åš[TinyStory](https://huggingface.co/afrideva/Tinystories-gpt-0.1-3m-GGUF),å…¶ç”±äºæ¨¡å‹å¤ªå°ï¼Œæ‰€ä»¥äº§ç”Ÿæ–‡æœ¬çš„æ•ˆæœæœ‰ç‚¹å·®ã€‚

é‚£ä¹ˆåŒå­¦å°±è¦é—®äº†ï¼Œæœ‰æ²¡æœ‰è¡¨ç°æ›´å¥½ä¸€ç‚¹çš„æ¨¡å‹å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼šæœ‰çš„å…„å¼Ÿï¼Œæœ‰çš„ã€‚

æˆ‘ä»¬æ¨èqwen2çš„0.5Bæ¨¡å‹ï¼ˆå½“ç„¶å…¶ä»–çš„GGUFæ¨¡å‹ä¹Ÿå¯ä»¥ï¼Œä¸è¿‡è¦è€ƒè™‘å¼€å‘æ¿åªæœ‰2Gè¿å­˜ï¼‰ã€‚
### E.0 åˆ›å»ºäº¤æ¢åˆ†åŒº
åœ¨è¿è¡Œå¤§å‹åº”ç”¨ç¨‹åºï¼Œå°¤å…¶æ˜¯åƒLlama.cppè¿™æ ·çš„å¤§è¯­è¨€æ¨¡å‹æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡åˆ°å¼€å‘æ¿ç‰©ç†å†…å­˜ï¼ˆRAMï¼‰ä¸è¶³çš„æƒ…å†µã€‚ä¸ºäº†è®©ç³»ç»Ÿåœ¨è¿™ç§æƒ…å†µä¸‹ä¾ç„¶èƒ½å¤Ÿè¿è¡Œï¼ˆå°½ç®¡æ€§èƒ½å¯èƒ½ä¼šæœ‰æ‰€ä¸‹é™ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®â€œäº¤æ¢åˆ†åŒºâ€ã€‚

**ä»€ä¹ˆæ˜¯äº¤æ¢åˆ†åŒºï¼Ÿ**
äº¤æ¢åˆ†åŒº (Swap Space)ï¼Œå¸¸è¢«ç§°ä¸ºâ€œè™šæ‹Ÿå†…å­˜â€çš„ä¸€éƒ¨åˆ†ï¼Œæ˜¯æ“ä½œç³»ç»Ÿåœ¨ç¡¬ç›˜æˆ–å…¶ä»–æŒä¹…æ€§å­˜å‚¨è®¾å¤‡ï¼ˆåœ¨DAYU200ä¸Šé€šå¸¸æ˜¯eMMCå†…éƒ¨å­˜å‚¨ï¼‰ä¸Šåˆ’åˆ†å‡ºæ¥çš„ä¸€å—åŒºåŸŸã€‚
- å·¥ä½œåŸç†ï¼š å½“ç³»ç»Ÿçš„ç‰©ç†å†…å­˜ (RAM) å³å°†è€—å°½æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šå°†RAMä¸­ä¸€äº›æš‚æ—¶ä¸æ´»è·ƒçš„æ•°æ®ï¼ˆç§°ä¸ºâ€œå†…å­˜é¡µâ€ï¼‰ä¸´æ—¶ç§»åŠ¨åˆ°äº¤æ¢ç©ºé—´ä¸­ï¼Œä»è€Œé‡Šæ”¾å‡ºç‰©ç†å†…å­˜ç»™å½“å‰æ›´éœ€è¦çš„æ´»åŠ¨è¿›ç¨‹ä½¿ç”¨ã€‚å½“é‚£äº›è¢«ç§»åˆ°äº¤æ¢ç©ºé—´çš„æ•°æ®å†æ¬¡éœ€è¦è¢«è®¿é—®æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šå†å°†å®ƒä»¬ä»äº¤æ¢ç©ºé—´è¯»å›åˆ°RAMä¸­ã€‚
- ç›®çš„ï¼š
    - æ‰©å±•å¯ç”¨å†…å­˜ï¼š ä½¿å¾—ç³»ç»Ÿèƒ½å¤Ÿè¿è¡Œæ¯”å®é™…ç‰©ç†å†…å­˜æ›´å¤§çš„ç¨‹åºæˆ–åŒæ—¶è¿è¡Œæ›´å¤šçš„ç¨‹åºã€‚
    - é˜²æ­¢å†…å­˜æº¢å‡º (Out-Of-Memory, OOM)ï¼š åœ¨ç‰©ç†å†…å­˜å®Œå…¨ç”¨å°½æ—¶ï¼Œé¿å…ç³»ç»Ÿå› æ— æ³•åˆ†é…å†…å­˜è€Œç›´æ¥å´©æºƒæˆ–æ€æ­»é‡è¦è¿›ç¨‹ã€‚

**å¦‚ä½•åˆ›å»ºäº¤æ¢åˆ†åŒºï¼Ÿ**

```sh
# hdc shell è¿›å…¥å¼€å‘æ¿æ‰§è¡Œ
cd data/llama_file

# åœ¨2GBçš„dayu200ä¸ŠåŠ swapäº¤æ¢ç©ºé—´
# æ–°å»ºä¸€ä¸ªç©ºçš„ram_ohosæ–‡ä»¶
touch ram_ohos
# åˆ›å»ºä¸€ä¸ªç”¨äºäº¤æ¢ç©ºé—´çš„æ–‡ä»¶ï¼ˆ8GBå¤§å°çš„äº¤æ¢æ–‡ä»¶ï¼‰
dd if=/dev/zero of=/data/ram_ohos bs=1G count=8
# è®¾ç½®æ–‡ä»¶æƒé™ï¼Œä»¥ç¡®ä¿æ‰€æœ‰ç”¨æˆ·å¯ä»¥è¯»å†™è¯¥æ–‡ä»¶ï¼š
chmod 777 /data/ram_ohos
# å°†æ–‡ä»¶è®¾ç½®ä¸ºäº¤æ¢ç©ºé—´ï¼š
mkswap /data/ram_ohos
# å¯ç”¨äº¤æ¢ç©ºé—´ï¼š
swapon /data/ram_ohos
# æŸ¥çœ‹å†…å­˜ç©ºé—´:
free -m
```

### E.1 ä½¿ç”¨qwen2çš„0.5Bæ¨¡å‹
> å¦‚æœä½ åªæ˜¯æƒ³è¦å°è¯•ä¸€ä¸‹ï¼Œå¹¶ä¸æƒ³è‡ªå·±æ„å»ºï¼Œç›´æ¥ä¸‹è½½ç¿å®¢ç½‘ç›˜ä¸­ç¬¬äºŒé˜¶æ®µç´ æä¸­çš„Demoå³å¯ï¼ˆhttps://rec.ustc.edu.cn/share/dfbc3380-2b3c-11f0-aee2-27696db61006 ä¸­çš„`qwen-Demo.hap`ï¼‰
1. ä¸‹è½½qwen2çš„0.5Bæ¨¡å‹ï¼Œä¸‹è½½åœ°å€ï¼šhttps://huggingface.co/Qwen/Qwen2-0.5B-Instruct-GGUF/tree/main ï¼Œä¸‹è½½å…¶ä¸­qwen2-0_5b-instruct-q4_0.ggufå³å¯
2. å°†å…¶æ”¾å…¥`entry/src/main/resources/resfile`æ–‡ä»¶å¤¹ä¸‹
3. ä¿®æ”¹`entry/src/main/ets/pages/Index.ets`ï¼Œä¿®æ”¹å…¶ä¸­çš„`modelName`å˜é‡ä¸º:
    ```js
    @State modelName: string = 'qwen2-0_5b-instruct-q4_0.gguf';
    ```
4. é‡æ–°æ„å»ºåº”ç”¨è¿è¡Œå³å¯ï¼ˆç”±äºåŠ è½½æ¨¡å‹æ—¶é—´è¿‡é•¿ï¼Œå¯èƒ½ä¼šå­˜åœ¨appfreezeå¯¼è‡´åº”ç”¨é—ªé€€ï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡ï¼ŒçœŸæ­£æ„Ÿå…´è¶£è”ç³»åŠ©æ•™ï¼‰æ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š
![alt text](./assets/æ•ˆæœå›¾.jpg)
